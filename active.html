<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<title></title>
		<link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
		<style type="text/css">
			.item{
			   
                margin-top:3vh;
                color:#00a0e8;
                
                min-height: 8vh;
            }
            .item .left{
                float:left;
               display:inline-block;
                position: relative;
                width: 50%;
                height:8vh;
                box-sizing:border-box;
            }
            .item .left img{
                display: block;
                position: absolute;
                top: 0;
                right:3vw;
                line-height: 8vh;
                height:100%;
                
            }
            .item .right{
                display:inline-block;
                width: 50%;
                box-sizing:border-box;
                position: relative;
                text-align: left;
                padding-left:3vw;
                line-height: 8vh;
            }
            
            .wrap{
                
                   margin: 0 auto;
                   padding-top:10vh;
            }
            body{
                z-index: 555555;
                background: #fff;
            }
            .title{
              height:10vh;
              line-height: 10vh;
              text-align: center;  
            }
            #header2{
                display:none;
            }
		</style>
	</head>
	<body>
	    <div id='header1' class="uh bc-head  ubb bc-border" data-control="HEADER" >
            <div class="ub">
                <div class="nav-btn" id="nav-left">
                    <div class="fa fa-1g ub-img1" onclick='toggle()'>
                        <img src="image/bread.png"/>
                    </div>
                </div>
                <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">重新激活</h1>
                <div class="nav-btn" id="nav-right">
                    <div class="fa  fa-1g  ub-img1">
                    </div>
                </div>
            </div>
        </div>
        
        <div id='header2' class="uh bc-head  ubb bc-border" data-control="HEADER" >
            <div class="ub">
                <div class="nav-btn" id="nav-left">
                   
                </div>
                <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">令牌激活</h1>
                <div class="nav-btn" id="nav-right">
                    <div class="fa  fa-1g  ub-img1">
                    </div>
                </div>
            </div>
        </div>
	    <div  class='wrap'>
            
            <div  class='item-wrap'>
                
                <div class='title'>
                    请选择令牌激活方式
                </div>
                <div class='item' onclick='handleLogin()' >
                    <div class='left'>
                        <img src="image/icon_login.png"/>
                    </div>
                    <div class='right'>
                         
                                                        登陆激活
                        
                    </div>
                   
                </div>
                <div class='item' onclick='handleScan()'>
                    <div class='left'>
                        <img src="image/scan.png"/>
                    </div>
                    <div class='right'>
                         
                                                        扫码激活
                        
                    </div>
                   
                </div>
                <div class='item' onclick='handlePickImage()'>
                    <div class='left'>
                        <img src="image/image.png"/>
                    </div>
                    <div class='right'>
                         
                                                        读图激活
                        
                    </div>
                   
                </div>
                
            </div>
        </div>

	</body>
</html>

<script src="js/aes.js"></script>
<script src="js/appcan.js">
        </script>
        <script src="js/appcan.control.js">
        </script>
        <script src="js/appcan.scrollbox.js">
        </script>
        <script src="js/template.import.js">
        </script>
        <script src="./assets/mvvm/index.js">
        </script>
        <script src="./js/index.js">
        </script>
<!-- 日期转化 -->
<script src="js/date.js">
</script>
<script type="text/javascript" charset="utf-8">


//aes解密和加密开始


var _key = CryptoJS.enc.Utf8.parse("T#s)STq~whp]b52G"); 
var _iv = CryptoJS.enc.Utf8.parse('Yw*M3^6JpV%0U@qk'); 

/**
 * 加密（需要先加载lib/aes/aes.min.js文件）
 * @param word
 * @returns {*}
 */
function encrypt(word){
    var srcs = CryptoJS.enc.Utf8.parse(word);
    var encrypted = CryptoJS.AES.encrypt(srcs, _key, {iv:_iv,mode:CryptoJS.mode.CBC,padding: CryptoJS.pad.Pkcs7});
    return encrypted.toString();
}

/**
 * 解密
 * @param word
 * @returns {*}
 */
function decrypt(word){
    var decrypt = CryptoJS.AES.decrypt(word, _key, {iv:_iv,mode:CryptoJS.mode.CBC,padding: CryptoJS.pad.Pkcs7});
    return CryptoJS.enc.Utf8.stringify(decrypt).toString();
}

//aes解密和加密结束

        // window.uexOnload = function(type){
// 
//             
// 
            // var name = uexWidgetOne.platformName;
//             
            // var params  = {
//                 
                // leftSliding:{
                    // width:0,
                    // url:"draw.html"
                // }
//                 
            // };
//             
            // var paramStr = JSON.stringify(params);
//             
            // uexWindow.setSlidingWindow(paramStr);
//             
//             
        // }
function ScannerSuccessCallBack(opCode, dataType, data) {
 
    
    data = JSON.parse(data);
    var str = data.code.split(" ");
    parseCode(str);
    
}
//解析二维码数据
function parseCode (str) {
    
    
    if(str.length == 5){
       //服务号
       var imagesn = str[0];
       
       //令牌号
       var num = str[1];
       
       //标识
       var info = decrypt(str[2]);
       
       //有效期
       var validtime = decrypt(str[3]).toString();
       
       //种子
       var seed = decrypt(str[4]);
      
       if(info == 'JSHS'){
            //判断二维码是否在有效期
            var now = new Date().Format("yyyy-MM-dd hh:mm:ss");
            var cvalidtime = validtime.slice(0,4)+'-'+validtime.slice(4,6)+'-'+validtime.slice(6,8)+' '+validtime.slice(8,10)+':'+validtime.slice(10,12)+':00';

            if(now<cvalidtime){
                appcan.locStorage.val('imagesn',imagesn);
                appcan.locStorage.val('num',num);
                appcan.locStorage.val('seed',seed);
                
               
                                        //解析成功后跳转到首页
                uexWindow.open('index', '0', "index.html", '2', '', '', 0);
            }else{
                appcan.window.openToast({
                    msg:'二维码过期',
                    duration:1000,
                    position:5,
                    type:0
                });
               
            }
       }else{
           appcan.window.openToast({
                msg:'无效标识',
                duration:1000,
                position:5,
                type:0
            });
          // 无效标识
       }
       
    }else{
        appcan.window.openToast({
                msg:'无效二维码',
                duration:1000,
                position:5,
                type:0
            });
        //无效二维码
    }
}
function handleSaveCode (){
    
}
function handleScan () {

    uexScanner.open();
}


function handleLogin () {
    uexWindow.open('login', '0', "login.html", '2', '', '', 0);
}
function handlePickImage() {
     
    var data = {
        min:1,
        max:1,
        quality:1,
        detailedInfo:true
    }
    var json = JSON.stringify(data);
    uexImage.openPicker(json)
 
}


function toggle () {
    var params  = {
        mark:0,
        reload:1
    };
    uexWindow.toggleSlidingWindow(params);
}

var seed = appcan.locStorage.getVal('seed');
var num = appcan.locStorage.getVal('num');
if(!seed){
    var header1 = document.getElementById('header1');
    var header2 = document.getElementById('header2');
    header1.style.display = 'none';
    header2.style.display = 'block';
}







window.uexOnload = function(){
    uexWindow.setReportKey(0, 1);
    uexWindow.onKeyPressed = function() {
        if(!seed){
                
            uexWidgetOne.exit(0);
            
        } else{
            appcan.window.open('home','home.html',0);
        } 
        
    }
    uexScanner.cbOpen = ScannerSuccessCallBack;
    var params  = {
                
        leftSliding:{
            width:0,
            url:"draw.html"
        }
        
    };
    if(!seed){
        var paramStr = JSON.stringify(params);
        var marks = {
            mark:1
        }
        var markStr = JSON.stringify(marks)
        
        uexWindow.setSlidingWindow(paramStr);
    }
    uexImage.onPickerClosed=function(info){
        
        info = JSON.parse(info);
        if(info.data.length){
            var url = info.data[0];  
            var result = uexScanner.recognizeFromImage(url);  
            
            var str = result.split(" ");
            parseCode(str);
        }
        
    }
    
}
	// uexWindow.setMultilPopoverFlippingEnbaled(1)
	
	
	
</script>
