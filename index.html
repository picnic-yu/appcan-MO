<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    
    <head>
        <title>
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
        <link rel="stylesheet" href="./css/index.css">
        
    </head>
    
    <body class="" ontouchstart>
        <div class="uh bc-head  ubb bc-border" data-control="HEADER" >
            <div class="ub">
                <div class="nav-btn" id="nav-left">
                    <div class="fa fa-1g ub-img1" onclick='toggle()'>
                        <img src="image/bread.png"/>
                    </div>
                </div>
                <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">MO动态口令</h1>
                <div class="nav-btn" id="nav-right">
                    <div class="fa  fa-1g  ub-img1">
                    </div>
                </div>
            </div>
        </div>
            
        <div class="content">
            <div class="timer-group">
  
                <div class="timer minute">
                    <div class="hand">
                        <span id='leftItem'></span>
                    </div>
                    <div class="hand">
                        <span id='rightItem'></span>
                    </div>
                </div>
  
                <div class="face" id='password'>222345
                    
                </div>
            </div>
            <div id="timeEnd">
                11
            </div>
            <div id="footer">
                22
            </div>
        </div>   
        
        
        <script src="js/appcan.js">
        </script>
        <script src="js/appcan.control.js">
        </script>
        <script src="js/appcan.scrollbox.js">
        </script>
        <script src="js/template.import.js">
        </script>
        <script src="./assets/mvvm/index.js">
        </script>
        <script src="./js/index.js">
        </script>
        <!-- outh密码 -->
        <script src="js/sjcl.js"></script>
    </body>
    <script >
  
        window.uexOnload = function(type){

            

            var name = uexWidgetOne.platformName;
            
            var params  = {
                
                leftSliding:{
                    width:700,
                    url:"draw.html"
                }
                
            };
            
            var paramStr = JSON.stringify(params);
            var marks = {
                mark:0
            }
            var markStr = JSON.stringify(marks)
            
            uexWindow.setSlidingWindow(paramStr);
            
            uexWindow.setSlidingWindowEnabled(1);
            
            var num = appcan.locStorage.getVal('num');
            var seed = appcan.locStorage.getVal('seed');
            if(num && seed){
                var footer = document.getElementById('footer');
                footer.innerText = num;
            
                GeneratePassword(seed);
            }
            
        }
        function toggle () {
            var params  = {
                mark:0,
                reload:1
            };
            uexWindow.toggleSlidingWindow(params);
        }
        
        
        
        
        
        
        
        
    //圆环动画开始       
        var defaults = {}
          , one_second = 1000
          , one_minute = one_second * 60
          , one_hour = one_minute * 60
          , one_day = one_hour * 24
          , startDate = new Date()
          , face = document.getElementById('lazy');
        var $ = (id) => {
            return document.getElementById(id);
        }
        // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
        var requestAnimationFrame = (function() {
            return  window.requestAnimationFrame       || 
                    window.webkitRequestAnimationFrame || 
                    window.mozRequestAnimationFrame    || 
                    window.oRequestAnimationFrame      || 
                    window.msRequestAnimationFrame     || 
                function( callback ){
                window.setTimeout(callback, 1000 / 60);
                };
        }());
        
        tick();
        
        function tick() {
        
          var now = new Date()
            , s = now.getSeconds(); //获取秒
            if(s == 0){
                var seed = appcan.locStorage.getVal('seed');
                GeneratePassword(seed);
            }
            
            if(s>=30){
                let num = 225 + (s-30) * 6;
                $('rightItem').style.transform = "rotate(405deg)";
                
                $('leftItem').style.transform = `rotate(${num}deg)`;
            }else{
                let num = 225 + s * 6;
                $('rightItem').style.transform =   `rotate(${num}deg)`;
                $('leftItem').style.transform = "rotate(225deg)";
            }
           
         
           
            var timeEnd = $('timeEnd');
            timeEnd.innerText = '下一动态口令将更换与 '+(60-s)+' 秒后'
            requestAnimationFrame(tick);
          
        }
        //圆环动画结束
        
        
        
        
  //生成密码      
function HOTP(K, C){
    var key = sjcl.codec.base32.toBits(K);
    // Count is 64 bits long.  Note that JavaScript bitwise operations make
    // the MSB effectively 0 in this case.
    var count = [((C & 0xffffffff00000000) >> 32), C & 0xffffffff];
    var otplength = 6;

    var hmacsha1 = new sjcl.misc.hmac(key, sjcl.hash.sha1);
    var code = hmacsha1.encrypt(count);

    var offset = sjcl.bitArray.extract(code, 152, 8) & 0x0f;
    var startBits = offset * 8;
    var endBits = startBits + 4 * 8;
    var slice = sjcl.bitArray.bitSlice(code, startBits, endBits);
    var dbc1 = slice[0];
    var dbc2 = dbc1 & 0x7fffffff;
    var otp = dbc2 % Math.pow(10, otplength);
    var result = otp.toString();
    while (result.length < otplength)
    {
        result = '0' + result;
    }
    return result;
}

function GeneratePassword(seed)
{
    try{
        seed = getEncodeString(seed);
        var secret = seed;
       var ctime = Math.floor((new Date() - 0) / 30000);
       
       var otp = HOTP(secret, ctime);
       var password = document.getElementById('password');
       password.innerText = otp;
       
    }catch(e){
       
    }
   
   
}




// base32
/** 
*加密函数 
*返回被编码加密的字符串 
*/  
  
function getEncodeString(srcString) {
    //var srcString = 'abc';
    var BASE32CHAR = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";


    var i = 0;
    var index = 0;
    var digit = 0;
    var currByte;
    var nextByte;
    var retrunString = '';


    for (var i = 0; i < srcString.length; ) {
        //var          index    = 0;
        currByte = (srcString.charCodeAt(i) >= 0) ? srcString.charCodeAt(i)
                               : (srcString.charCodeAt(i) + 256);


        if (index > 3) {
            if ((i + 1) < srcString.length) {
                nextByte = (srcString.charCodeAt(i + 1) >= 0)
                                         ? srcString.charCodeAt(i + 1)
                                          : (srcString.charCodeAt(i + 1) + 256);
            } else {
                nextByte = 0;
            }


            digit = currByte & (0xFF >> index);
            index = (index + 5) % 8;
            digit <<= index;
            digit |= (nextByte >> (8 - index));
            i++;
        } else {
            digit = (currByte >> (8 - (index + 5))) & 0x1F;
            index = (index + 5) % 8;


            if (index == 0) {
                i++;
            }
        }


        retrunString = retrunString + BASE32CHAR.charAt(digit);
    }
    return retrunString.toLowerCase();
}
          
/** 
*解密函数 
*返回解密的字符串 
*/  
 var getDecodeString = function (encodeString){  
        var    i;  
        var    index;  
        var    lookup;  
        var    offset;  
        var    digit;  
        var encodeString = encodeString.toUpperCase();  
        var stringLen = parseInt((encodeString.length * 5) / 8);  
        var bytes = new Array(stringLen);  
        for ( var a=0;a<stringLen;a++){  
            bytes[a]=0;  
        }  
  
        for (i = 0, index = 0, offset = 0; i < encodeString.length; i++) {  
            var charCode0 = '0'.charCodeAt(0);  
            lookup = encodeString.charCodeAt(i) - charCode0;  
  
            if ((lookup < 0) || (lookup >= BASE32LOOOKUP.length)) {  
                continue;  
            }  
  
            digit = BASE32LOOOKUP[lookup];  
  
            if (digit == 0xFF) {  
                continue;  
            }  
  
            if (index <= 3) {  
                index = (index + 5) % 8;  
  
                if (index == 0) {  
                    bytes[offset] = bytes[offset] | digit;  
                      
                    offset++;  
  
                    if (offset >= bytes.length) {  
                        break;  
                    }  
                } else {  
                    bytes[offset] = bytes[offset] | (digit << (8 - index));  
                      
                }  
            } else {  
                index = (index + 5) % 8;  
                bytes[offset] = bytes[offset] | (digit >>> index);  
                  
                offset++;  
  
                if (offset >= bytes.length) {  
                    break;  
                }  
  
                bytes[offset] = bytes[offset] | (digit << (8 - index));  
                if(bytes[offset]>=256){  
                  
                    //var lp = parseInt(bytes[offset]/256);  
                    
                    bytes[offset] %= 256;   
                }  
            }  
        }  
  
        //return bytes.join(',');  
        var realkeyString = '';  
        var decodeString = '';  
        for ( var a=0;a<bytes.length;a++){  
                                          
            var realkey  = String.fromCharCode(bytes[a]);    
            realkeyString += realkey;  
            //decodeString += bytes[a];  
              
        }  
        return realkeyString;  
          
}   
          
          
             
    </script>
</html>